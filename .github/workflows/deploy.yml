name: Build and Deploy MobVue

on:
  push:
    branches:
      - main
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:

jobs:
  build-and-deploy:
    # è¿è¡Œç¯å¢ƒ
    runs-on: ubuntu-latest
    # æƒé™è®¾ç½®
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      # è®¾ç½®Node.jsç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: pnpm

      # è®¾ç½®pnpmåŒ…ç®¡ç†å™¨
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: latest
          run_install: false

      # å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          echo "Installing dependencies..."
          pnpm install --frozen-lockfile

      # æ„å»ºé¡¹ç›®
      - name: Build project
        run: |
          echo "Building project..."
          pnpm build

      # éªŒè¯æ„å»ºäº§ç‰©
      - name: Verify build
        run: |
          echo "Verifying build output..."
          if [ ! -d "dist" ]; then
            echo "Error: Build directory 'dist' not found!"
            exit 1
          fi
          echo "Build verified successfully!"

      # éƒ¨ç½²åˆ°GitHub Pages
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          # ä½¿ç”¨GitHubä»¤ç‰Œè¿›è¡Œèº«ä»½éªŒè¯
          token: ${{ secrets.MOBVUE }}
          # éƒ¨ç½²ç›®æ ‡åˆ†æ”¯
          branch: gh-pages
          # æ„å»ºäº§ç‰©ç›®å½•
          folder: dist
          # æ¸…ç†æ—§æ–‡ä»¶
          clean: true
          # å•æäº¤æ¨¡å¼
          single-commit: true
          # æäº¤ä¿¡æ¯
          commit-message: "chore: deploy ${{ github.sha }}"

      # éƒ¨ç½²æˆåŠŸé€šçŸ¥
      - name: Deployment notification
        if: success()
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸ“š Your site will be available at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"

      # éƒ¨ç½²å¤±è´¥é€šçŸ¥
      - name: Deployment failure notification
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "Please check the workflow logs for more details."
