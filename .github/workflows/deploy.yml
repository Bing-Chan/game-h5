name: Build and Deploy MobVue

on:
  push:
    branches:
      - main
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:

jobs:
  build-and-deploy:
    # è¿è¡Œç¯å¢ƒ
    runs-on: ubuntu-latest
    # æƒé™è®¾ç½®
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      # è®¾ç½®Node.jsç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          # ä½¿ç”¨pnpmç¼“å­˜
          cache: pnpm
          # ç¼“å­˜è·¯å¾„
          cache-dependency-path: pnpm-lock.yaml

      # è®¾ç½®pnpmåŒ…ç®¡ç†å™¨
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.6
          run_install: false
          # ç¡®ä¿pnpmè¢«æ­£ç¡®æ·»åŠ åˆ°PATH
          standalone: true

      # éªŒè¯pnpmå®‰è£…
      - name: Verify pnpm installation
        run: |
          echo "Verifying pnpm installation..."
          pnpm --version
          which pnpm

      # å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          echo "Installing dependencies..."
          pnpm install --frozen-lockfile

      # æ„å»ºé¡¹ç›®
      - name: Build project
        run: |
          echo "Building project..."
          echo "Node.js version: $(node -v)"
          echo "pnpm version: $(pnpm -v)"
          # å¯ç”¨è¯¦ç»†è¾“å‡ºä»¥ä¾¿è°ƒè¯•
          pnpm build --debug || {
            echo "æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯"
            exit 1
          }

      # éªŒè¯æ„å»ºäº§ç‰©
      - name: Verify build
        run: |
          echo "Verifying build output..."
          # æ£€æŸ¥distç›®å½•æ˜¯å¦å­˜åœ¨
          if [ ! -d "dist" ]; then
            echo "Error: Build directory 'dist' not found!"
            exit 1
          fi
          # åˆ—å‡ºdistç›®å½•å†…å®¹
          ls -la dist/
          # æ£€æŸ¥æ˜¯å¦æœ‰å…³é”®æ–‡ä»¶
          if [ -f "dist/index.html" ]; then
            echo "âœ“ index.html found"
          else
            echo "âœ— index.html not found"
            exit 1
          fi
          echo "Build verified successfully!"

      # éƒ¨ç½²åˆ°GitHub Pages
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          # ä½¿ç”¨GitHubä»¤ç‰Œè¿›è¡Œèº«ä»½éªŒè¯
          token: ${{ secrets.MOBVUE }}
          # éƒ¨ç½²ç›®æ ‡åˆ†æ”¯
          branch: gh-pages
          # æ„å»ºäº§ç‰©ç›®å½•
          folder: dist
          # æ¸…ç†æ—§æ–‡ä»¶
          clean: true
          # å•æäº¤æ¨¡å¼
          single-commit: true
          # æäº¤ä¿¡æ¯
          commit-message: "chore: deploy ${{ github.sha }}"

      # éƒ¨ç½²æˆåŠŸé€šçŸ¥
      - name: Deployment notification
        if: success()
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸ“š Your site will be available at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"

      # éƒ¨ç½²å¤±è´¥é€šçŸ¥
      - name: Deployment failure notification
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "Please check the workflow logs for more details."
